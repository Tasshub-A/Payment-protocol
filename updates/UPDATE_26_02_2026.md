# Updated Smart Contract Report

## Main Reason for Redeploy

The contract was redeployed to introduce **referral functionality**.

---

## 1. New Contract Address

```

C3Veo4eAWJruyBVBtedtRm2oKpvg53v2dxZmjMzEDWy1

```

---

## 2. Updates to `purchaseWithSol`

### What Changed

The method now includes:

- A new argument: `referrer_fee_bps`
  - Maximum value: `500` (5%)
- A new optional account: `referrer`
  - If provided, this account receives a portion of the platform fee in SOL.

---

### Fee Logic (Important)

Default platform fee:
```

1500 bps (15%)

```

If a referrer is provided:
- Referrer receives: `100 bps (1%)`
- Platform fee becomes: `1400 bps (14%)`

⚠️ This means:

If `referrer` is passed:
```

feeBps = 1400
referrerFeeBps = 100

```

If `referrer` is NOT passed:
```

feeBps = 1500
referrerFeeBps = 0

````

Backend/frontend logic must ensure:
- 100 bps is deducted from the platform fee when a referrer exists.

---

### Example: With Referrer

```ts
const amount = new BN(0.5 * LAMPORTS);
const feeBps = 1400;
const referrerFeeBps = 100;

const contentId = "content-sol-with-ref";
const purchaseId = "purchase-sol-with-ref";

const tx = await program.methods
  .purchaseWithSol(contentId, purchaseId, amount, feeBps, referrerFeeBps)
  .accounts({
    buyer,
    creator,
    platform,
    referrer,
  })
  .rpc();
````

---

### Example: Without Referrer

```ts
feeBps = 1500;
referrerFeeBps = 0;

.accounts({
  buyer,
  creator,
  platform,
  referrer: null, // IMPORTANT: must explicitly pass null
})
```

⚠️ Even though `referrer` is optional, `null` must be passed explicitly.

---

## 3. Updates to `purchaseWithToken`

### What Changed

Added:

* `referrer_fee_bps` argument
* Two optional accounts:

  * `referrer`
  * `referrer_token_account`

If a referrer is provided, **both accounts must be passed** to ensure correct reward distribution.

---

### Required Parameters

When referrer exists:

```ts
referrerFeeBps: 0 | someNumber

.accounts({
  referrer: referrer,
  referrer_token_account: referrer_token_account
})
```

When referrer does NOT exist:

```ts
referrerFeeBps = 0

.accounts({
  referrer: null,
  referrer_token_account: null
})
```

Fee logic is identical to the SOL purchase logic.

---

### Additional Reference

For extended usage examples, see:

* `scripts/`
* `tests/`

---

## 4. Updated `PurchaseEvent`

The event structure has been updated to support referral tracking.

```rust
pub struct PurchaseEvent {
    pub content_id: String,
    pub purchase_id: String,
    pub buyer: Pubkey,
    pub creator: Pubkey,
    pub platform: Pubkey,
    pub referrer: Option<Pubkey>,      // NEW
    pub mint: Option<Pubkey>,
    pub currency_type: CurrencyType,
    pub decimals: u8,
    pub amount: u64,
    pub creator_amount: u64,
    pub platform_fee: u64,
    pub referrer_fee: u64,             // NEW
    pub fee_bps: u16,
    pub slot: u64,
    pub timestamp: i64,
}
```

### New Fields

* `referrer: Option<Pubkey>`
* `referrer_fee: u64`

These fields allow tracking:

* Whether a referral was used
* How much the referrer earned

---

## 5. Updated Test Structure & `.env.example`

### Changes

* Supported tokens are now stored in an array.
* For easier local SPL token testing:

  * A local test token is created before executing token purchases.
  * This token address is pre-added to the supported tokens list.
  * It will be removed before mainnet deployment.

This allows:

* Easier local development
* Predictable token behavior during tests
* No need to manually prepare SPL tokens before testing

---

## Summary of Breaking Changes

* `purchaseWithSol` now requires:

  * `referrer_fee_bps`
  * Explicit `referrer` account (or `null`)

* `purchaseWithToken` now requires:

  * `referrer_fee_bps`
  * `referrer` or `null`
  * `referrer_token_account` or `null`
* `PurchaseEvent` updated with referral fields
* Fee logic must dynamically adjust when referrer exists (on backend/frontend side)